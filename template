{
  "Resources": {
    "AppBuildRole": {
      "Type": "AWS::IAM::Role",
      "Properties": {
        "AssumeRolePolicyDocument": {
          "Version": "2012-10-17",
          "Statement": [
            {
              "Effect": "Allow",
              "Principal": {
                "Service": "codebuild.amazonaws.com"
              },
              "Action": "sts:AssumeRole"
            }
          ]
        }
      }
    },
    "BuildLogPolicy": {
      "Type": "AWS::IAM::Policy",
      "Properties": {
        "PolicyName": "BuildLogAccess",
        "PolicyDocument": {
          "Version": "2012-10-17",
          "Statement": [
            {
              "Effect": "Allow",
              "Action": [
                "logs:CreateLogGroup",
                "logs:CreateLogStream",
                "logs:PutLogEvents"
              ],
              "Resource": [
                {
                  "Fn::Sub": "arn:aws:logs:${AWS::Region}:${AWS::AccountId}:log-group:/aws/codebuild/${AppBuildProject}"
                },
                {
                  "Fn::Sub": "arn:aws:logs:${AWS::Region}:${AWS::AccountId}:log-group:/aws/codebuild/${AppBuildProject}:*"
                }
              ]
            }
          ]
        },
        "Roles": [
          {
            "Ref": "AppBuildRole"
          }
        ]
      }
    },
    "AppBuildProject": {
      "Type": "AWS::CodeBuild::Project",
      "Properties": {
        "Name": "MyAppBuildProject",
        "Description": "CodeBuild project for Java application",
        "Source": {
          "Type": "GITHUB",
          "Location": "https://github.com/c1ayer/java-project.git",
          "BuildSpec": "buildspec.yml"
        },
        "Artifacts": {
          "Type": "S3",
          "Location": {
            "Fn::Sub": "my-artifacts-bucket-${AWS::Region}"
          },
          "Packaging": "ZIP"
        },
        "Environment": {
          "Type": "LINUX_CONTAINER",
          "Image": "aws/codebuild/standard:5.0",
          "ComputeType": "BUILD_GENERAL1_SMALL"
        },
        "ServiceRole": {
          "Ref": "AppBuildRole"
        }
      }
    },
    "AppBuildProjectOutput": {
      "Type": "AWS::S3::Bucket",
      "Properties": {
        "BucketName": {
          "Fn::Sub": "my-artifacts-bucket-${AWS::Region}"
        }
      }
    }
  }
}
